<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrance Sounds - Browser Source</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: transparent;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #4caf50;
      border-radius: 4px;
      font-size: 14px;
      font-weight: bold;
      z-index: 9999;
    }

    #status.disconnected {
      color: #f44336;
    }

    #obs-warning {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      padding: 12px;
      background: rgba(255, 152, 0, 0.9);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      z-index: 9998;
      text-align: center;
    }

    #viewer-name {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      z-index: 1000;
    }

    #viewer-name.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="status">Disconnected</div>
  <div id="obs-warning">
    ‚ö†Ô∏è OBS Users: Make sure "Control audio via OBS" is <strong>UNCHECKED</strong> in browser source properties!
  </div>
  <div id="viewer-name"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    console.log('[EntranceSounds] Browser source loaded');

    const statusEl = document.getElementById('status');
    const viewerNameEl = document.getElementById('viewer-name');
    
    // Persistent audio element for Mac/OBS compatibility
    let audioPlayer = null;
    let audioUnlocked = false;
    let unlockAttempted = false;
    
    // Create persistent audio element
    function initAudio() {
      audioPlayer = document.createElement('audio');
      audioPlayer.style.display = 'none';
      document.body.appendChild(audioPlayer);
      
      console.log('[EntranceSounds] Audio player initialized');
    }
    
    // Unlock audio playback (required for Mac/Safari/OBS)
    async function unlockAudio() {
      if (audioUnlocked || !audioPlayer || unlockAttempted) return;
      
      unlockAttempted = true;
      console.log('[EntranceSounds] Unlocking audio...');
      
      try {
        // Create a very short beep to unlock
        audioPlayer.volume = 0.01; // Very quiet
        audioPlayer.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
        
        await audioPlayer.play();
        
        // Wait a tiny bit for it to actually play
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Stop and reset
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        audioPlayer.volume = 1;
        
        audioUnlocked = true;
        console.log('[EntranceSounds] ‚úì Audio unlocked successfully');
      } catch (error) {
        console.log('[EntranceSounds] Audio unlock failed:', error.message);
        console.log('[EntranceSounds] Audio will be unlocked on first user interaction');
        unlockAttempted = false; // Allow retry
      }
    }
    
    // Initialize audio on load
    initAudio();
    
    // Try to unlock immediately (works in OBS)
    setTimeout(() => unlockAudio(), 100);

    // Connect to Socket.IO server
    const socket = io('http://localhost:3737');

    socket.on('connect', () => {
      console.log('[EntranceSounds] Connected to server');
      statusEl.textContent = 'Connected';
      statusEl.classList.remove('disconnected');
    });

    socket.on('disconnect', () => {
      console.log('[EntranceSounds] Disconnected from server');
      statusEl.textContent = 'Disconnected';
      statusEl.classList.add('disconnected');
    });

    socket.on('connect_error', (error) => {
      console.error('[EntranceSounds] Connection error:', error);
      statusEl.textContent = 'Connection Error';
      statusEl.classList.add('disconnected');
    });

    // Listen for entrance sound events
    socket.on('entrance-sound', (data) => {
      console.log('[EntranceSounds] Received entrance sound:', data);
      playEntranceSound(data);
    });

    /**
     * Play entrance sound for a viewer
     */
    function playEntranceSound(data) {
      const { viewer_username, sound_file_path, volume } = data;

      console.log(`[EntranceSounds] Playing sound for ${viewer_username}:`, sound_file_path);

      // Ensure audio is unlocked
      if (!audioUnlocked) {
        unlockAudio();
      }

      if (!audioPlayer) {
        console.error('[EntranceSounds] Audio player not initialized');
        return;
      }

      // Show viewer name
      if (viewer_username) {
        viewerNameEl.textContent = `üéâ ${viewer_username} has entered!`;
        viewerNameEl.classList.add('show');
      }

      // Set up event handlers
      const onEnded = () => {
        console.log('[EntranceSounds] Audio playback ended');
        cleanup();
        // Hide viewer name after sound finishes
        setTimeout(() => {
          viewerNameEl.classList.remove('show');
        }, 500);
      };
      
      const onError = (error) => {
        console.error('[EntranceSounds] Audio error:', error);
        console.error('[EntranceSounds] Failed to load:', sound_file_path);
        cleanup();
        // Hide viewer name on error
        setTimeout(() => {
          viewerNameEl.classList.remove('show');
        }, 2000);
      };
      
      const cleanup = () => {
        audioPlayer.removeEventListener('ended', onEnded);
        audioPlayer.removeEventListener('error', onError);
      };
      
      audioPlayer.addEventListener('ended', onEnded);
      audioPlayer.addEventListener('error', onError);

      // Convert volume from 0-100 to 0-1
      audioPlayer.volume = Math.max(0, Math.min(1, volume / 100));
      
      // Encode the file path as base64 (same as event actions)
      try {
        const encoded = btoa(unescape(encodeURIComponent(sound_file_path)));
        audioPlayer.src = `http://localhost:3737/media/${encodeURIComponent(encoded)}`;
      } catch (error) {
        console.error('[EntranceSounds] Error encoding file path:', error);
        cleanup();
        return;
      }
      
      // Play the audio
      const playPromise = audioPlayer.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            console.log('[EntranceSounds] Playback started successfully');
          })
          .catch(error => {
            console.error('[EntranceSounds] Play error:', error);
            cleanup();
          });
      }
    }

    // Test function (can be called from browser console)
    window.testEntranceSound = function(testPath) {
      console.log('[EntranceSounds] Running test...');
      
      // Use a test sound URL if no path provided
      const soundPath = testPath || '/Users/davidstafford/Music/Music/Media.localized/Music/Unknown Artist/Unknown Album/Aditi.mp3';
      
      playEntranceSound({
        viewer_username: 'TestViewer',
        sound_file_path: soundPath,
        volume: 75
      });
      
      console.log('[EntranceSounds] Test triggered! Check audio playback.');
      console.log('[EntranceSounds] If you hear nothing:');
      console.log('[EntranceSounds] 1. Check OBS browser source properties');
      console.log('[EntranceSounds] 2. Ensure "Control audio via OBS" is UNCHECKED');
      console.log('[EntranceSounds] 3. Check that the file path exists and is accessible');
      console.log('[EntranceSounds] 4. Try refreshing the browser source');
    };

    console.log('[EntranceSounds] Ready!');
    console.log('[EntranceSounds] Use window.testEntranceSound() to test');
    console.log('[EntranceSounds] Or: window.testEntranceSound("/path/to/your/audio.mp3")');
  </script>
</body>
</html>
